/* jshint quotmark: false */
<!doctype html>
<html class="no-js">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>WorldOrchestra</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <!-- build:css(.tmp) styles/main.css -->
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="styles/main.css">
        <!-- endbuild -->
        <!-- build:js scripts/vendor/modernizr.js -->
        <script src="bower_components/modernizr/modernizr.js"></script>
        <!-- endbuild -->
    </head>
    <body>
        <!--[if lt IE 10]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->


        <div class="hero-unit">
          <h1>'Allo, 'Allo!</h1>
          <p>You now have</p>
          <ul>
            <li>HTML5 Boilerplate</li>
            <li>jQuery</li>
            <li>Backbone.js</li>
            <li>Underscore.js</li>
            <li>Modernizr</li>
            <li>RequireJS</li>
            <li>Marionette</li>
          </ul>
        </div>
        <div>
            <button id="rewind"><i class="fa fa-fast-backward"></i></button>
            <button id="skipBack"><i class="fa fa-backward"></i></button>
            <button id="stop"><i class="fa fa-stop"></i></button>
            <button id="play"><i class="fa fa-play"></i></button>
            <button id="record"><i class="fa fa-play-circle" style="color:red"></i></button>
            <button id="skipForward"><i class="fa fa-forward"></i></button>
            <button id="forward"><i class="fa fa-fast-forward"></i></button>
            <span>Transport Time </span><span id="transportTime">0:0:0</span>
        <div>
        <div id="keys">
            <span>Octave </span><span id="octave">4</span>
            <button id="C4">C</button>
            <button id="Db4" style="background-color:black;color:white">Db</button>
            <button id="D4">D</button>
            <button id="Eb4" style="background-color:black;color:white">Eb</button>
            <button id="E4">E</button>
            <button id="F4">F</button>
            <button id="Gb4" style="background-color:black;color:white">Gb</button>
            <button id="G4">G</button>
            <button id="Ab4" style="background-color:black;color:white">Ab</button>
            <button id="A4">A</button>
            <button id="Bb4" style="background-color:black;color:white">Bb</button>
            <button id="B4">B</button>
            <button id="C5">C</button>
            <button id="Db5" style="background-color:black;color:white">Db</button>
            <button id="D5">D</button>
            <button id="Eb5" style="background-color:black;color:white">Eb</button>
            <button id="E5">E</button>
            <button id="F5">F</button>

        </div>
        <script type="text/template" id="sample-template">
            put some content <%= contentPlacement %>.
        </script>


        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->

<!--         <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X');ga('send','pageview');
        </script> -->
        
        <script src="bower_components/jquery/dist/jquery.js"></script>
        <script src="bower_components/tone/build/Tone.js"></script>
        <script src="indyFull.js"></script>

        <script>
        /* globals Tone, GUI */

        var synthOptions = {
            "portamento" : 0.05,
            "oscillator" : {
                "type" : "square"
            },
            "filter": {
                "Q": 6,
                "type": "lowpass",
                "rolloff": -24
            },
            "envelope": {
                "attack": 0.005,
                "decay": 0.01,
                "sustain": 0.9,
                "release": 0.001
            },
            "filterEnvelope": {
                "attack": 0.006,
                "decay": 0.02,
                "sustain": 0.5,
                "release": 0.001,
                "min": 10,
                "max": 4000
            }
        };

        var synth = new Tone.MonoSynth(synthOptions);
        var sampler = new Tone.MultiSampler({
            "A0" : "soundfont/acoustic_grand_piano-mp3/A0.mp3",
            "A1" : "soundfont/acoustic_grand_piano-mp3/A1.mp3",
            "A2" : "soundfont/acoustic_grand_piano-mp3/A2.mp3",
            "A3" : "soundfont/acoustic_grand_piano-mp3/A3.mp3",
            "A4" : "soundfont/acoustic_grand_piano-mp3/A4.mp3",
            "A5" : "soundfont/acoustic_grand_piano-mp3/A5.mp3",
            "A6" : "soundfont/acoustic_grand_piano-mp3/A6.mp3",
            "A7" : "soundfont/acoustic_grand_piano-mp3/A7.mp3",
            "B0" : "soundfont/acoustic_grand_piano-mp3/B0.mp3",
            "B1" : "soundfont/acoustic_grand_piano-mp3/B1.mp3",
            "B2" : "soundfont/acoustic_grand_piano-mp3/B2.mp3",
            "B3" : "soundfont/acoustic_grand_piano-mp3/B3.mp3",
            "B4" : "soundfont/acoustic_grand_piano-mp3/B4.mp3",
            "B5" : "soundfont/acoustic_grand_piano-mp3/B5.mp3",
            "B6" : "soundfont/acoustic_grand_piano-mp3/B6.mp3",
            "B7" : "soundfont/acoustic_grand_piano-mp3/B7.mp3",
            "C0" : "soundfont/acoustic_grand_piano-mp3/C0.mp3",
            "C1" : "soundfont/acoustic_grand_piano-mp3/C1.mp3",
            "C2" : "soundfont/acoustic_grand_piano-mp3/C2.mp3",
            "C3" : "soundfont/acoustic_grand_piano-mp3/C3.mp3",
            "C4" : "soundfont/acoustic_grand_piano-mp3/C4.mp3",
            "C5" : "soundfont/acoustic_grand_piano-mp3/C5.mp3",
            "C6" : "soundfont/acoustic_grand_piano-mp3/C6.mp3",
            "C7" : "soundfont/acoustic_grand_piano-mp3/C7.mp3",
            "C8" : "soundfont/acoustic_grand_piano-mp3/C8.mp3",
            "D0" : "soundfont/acoustic_grand_piano-mp3/D0.mp3",
            "D1" : "soundfont/acoustic_grand_piano-mp3/D1.mp3",
            "D2" : "soundfont/acoustic_grand_piano-mp3/D2.mp3",
            "D3" : "soundfont/acoustic_grand_piano-mp3/D3.mp3",
            "D4" : "soundfont/acoustic_grand_piano-mp3/D4.mp3",
            "D5" : "soundfont/acoustic_grand_piano-mp3/D5.mp3",
            "D6" : "soundfont/acoustic_grand_piano-mp3/D6.mp3",
            "D7" : "soundfont/acoustic_grand_piano-mp3/D7.mp3",
            "E0" : "soundfont/acoustic_grand_piano-mp3/E0.mp3",
            "E1" : "soundfont/acoustic_grand_piano-mp3/E1.mp3",
            "E2" : "soundfont/acoustic_grand_piano-mp3/E2.mp3",
            "E3" : "soundfont/acoustic_grand_piano-mp3/E3.mp3",
            "E4" : "soundfont/acoustic_grand_piano-mp3/E4.mp3",
            "E5" : "soundfont/acoustic_grand_piano-mp3/E5.mp3",
            "E6" : "soundfont/acoustic_grand_piano-mp3/E6.mp3",
            "E7" : "soundfont/acoustic_grand_piano-mp3/E7.mp3",
            "F0" : "soundfont/acoustic_grand_piano-mp3/F0.mp3",
            "F1" : "soundfont/acoustic_grand_piano-mp3/F1.mp3",
            "F2" : "soundfont/acoustic_grand_piano-mp3/F2.mp3",
            "F3" : "soundfont/acoustic_grand_piano-mp3/F3.mp3",
            "F4" : "soundfont/acoustic_grand_piano-mp3/F4.mp3",
            "F5" : "soundfont/acoustic_grand_piano-mp3/F5.mp3",
            "F6" : "soundfont/acoustic_grand_piano-mp3/F6.mp3",
            "F7" : "soundfont/acoustic_grand_piano-mp3/F7.mp3",
            "G0" : "soundfont/acoustic_grand_piano-mp3/G0.mp3",
            "G1" : "soundfont/acoustic_grand_piano-mp3/G1.mp3",
            "G2" : "soundfont/acoustic_grand_piano-mp3/G2.mp3",
            "G3" : "soundfont/acoustic_grand_piano-mp3/G3.mp3",
            "G4" : "soundfont/acoustic_grand_piano-mp3/G4.mp3",
            "G5" : "soundfont/acoustic_grand_piano-mp3/G5.mp3",
            "G6" : "soundfont/acoustic_grand_piano-mp3/G6.mp3",
            "Ab1" : "soundfont/acoustic_grand_piano-mp3/Ab1.mp3",
            "Ab2" : "soundfont/acoustic_grand_piano-mp3/Ab2.mp3",
            "Ab3" : "soundfont/acoustic_grand_piano-mp3/Ab3.mp3",
            "Ab4" : "soundfont/acoustic_grand_piano-mp3/Ab4.mp3",
            "Ab5" : "soundfont/acoustic_grand_piano-mp3/Ab5.mp3",
            "Ab6" : "soundfont/acoustic_grand_piano-mp3/Ab6.mp3",
            "Ab7" : "soundfont/acoustic_grand_piano-mp3/Ab7.mp3",
            "Bb0" : "soundfont/acoustic_grand_piano-mp3/Bb0.mp3",
            "Bb1" : "soundfont/acoustic_grand_piano-mp3/Bb1.mp3",
            "Bb2" : "soundfont/acoustic_grand_piano-mp3/Bb2.mp3",
            "Bb3" : "soundfont/acoustic_grand_piano-mp3/Bb3.mp3",
            "Bb4" : "soundfont/acoustic_grand_piano-mp3/Bb4.mp3",
            "Bb5" : "soundfont/acoustic_grand_piano-mp3/Bb5.mp3",
            "Bb6" : "soundfont/acoustic_grand_piano-mp3/Bb6.mp3",
            "Bb7" : "soundfont/acoustic_grand_piano-mp3/Bb7.mp3",
            "Bb0" : "soundfont/acoustic_grand_piano-mp3/Bb0.mp3",
            "Db1" : "soundfont/acoustic_grand_piano-mp3/Db1.mp3",
            "Db2" : "soundfont/acoustic_grand_piano-mp3/Db2.mp3",
            "Db3" : "soundfont/acoustic_grand_piano-mp3/Db3.mp3",
            "Db4" : "soundfont/acoustic_grand_piano-mp3/Db4.mp3",
            "Db5" : "soundfont/acoustic_grand_piano-mp3/Db5.mp3",
            "Db6" : "soundfont/acoustic_grand_piano-mp3/Db6.mp3",
            "Db7" : "soundfont/acoustic_grand_piano-mp3/Db7.mp3",
            "Db8" : "soundfont/acoustic_grand_piano-mp3/Db8.mp3",
            "Eb1" : "soundfont/acoustic_grand_piano-mp3/Eb1.mp3",
            "Eb2" : "soundfont/acoustic_grand_piano-mp3/Eb2.mp3",
            "Eb3" : "soundfont/acoustic_grand_piano-mp3/Eb3.mp3",
            "Eb4" : "soundfont/acoustic_grand_piano-mp3/Eb4.mp3",
            "Eb5" : "soundfont/acoustic_grand_piano-mp3/Eb5.mp3",
            "Eb6" : "soundfont/acoustic_grand_piano-mp3/Eb6.mp3",
            "Eb7" : "soundfont/acoustic_grand_piano-mp3/Eb7.mp3",
            "Gb1" : "soundfont/acoustic_grand_piano-mp3/Gb1.mp3",
            "Gb2" : "soundfont/acoustic_grand_piano-mp3/Gb2.mp3",
            "Gb3" : "soundfont/acoustic_grand_piano-mp3/Gb3.mp3",
            "Gb4" : "soundfont/acoustic_grand_piano-mp3/Gb4.mp3",
            "Gb5" : "soundfont/acoustic_grand_piano-mp3/Gb5.mp3",
            "Gb6" : "soundfont/acoustic_grand_piano-mp3/Gb6.mp3",
            "Gb7" : "soundfont/acoustic_grand_piano-mp3/Gb7.mp3"
         }, onload);
         //once loaded..
        synth.setVolume(-25);
        synth.toMaster();
        
        sampler.setVolume(0);
        sampler.toMaster();

        
                         //[time,               note, velocity]
        Tone.Note.daveScore = function (score){
                   var notes = [];
                   for (var inst in score){
                       var part = score[inst];
                       if (inst === "tempo"){
                           Tone.Transport.setBpm(part);
                       } else if (inst === "timeSignature"){
                           Tone.Transport.setTimeSignature(part[0], part[1]);
                       } else if (Array.isArray(part)){
                           for (var i = 0; i < part.length; i+=2){
                               var noteDescription = part[i];
                               var note;
                               if (Array.isArray(noteDescription)){
                                   var time = noteDescription[0];
                                   var value = noteDescription.slice(1);
                                   var dur_time1=time;
                                   var dur_time2 = part[i+1][0];
                                   var duration = function(start, end){
                                        var duration = Math.abs(Tone.Transport.toSeconds(end) - Tone.Transport.toSeconds(start));
                                        return duration
                                   };
                                   var noteDuration = duration(dur_time1, dur_time2);
                                   note = new Tone.Note(inst, time, value, noteDuration);
                               } else {
                                   note = new Tone.Note(inst, noteDescription);
                               }
                               notes.push(note);
                           }
                       } else {
                           throw new TypeError("score parts must be Arrays");
                       }
                   }
                   console.log('notes->', notes);
                   console.log(notes.length);
                   return notes;
               };

        // Tone.Note.daveScore(indyFull, {
        //     "sampler" : "tk1"
        // });
        // Tone.Note.route("sampler", function(time, note, velocity, duration){
        //     sampler.triggerAttackRelease(note, duration, time, 1);
        //     // debugger;
        // });
        
        // Tone.Note.daveScore(indyFull, {
        //     "sampler" : "tk2"
        // });
        // Tone.Note.route("sampler", function(time, note, velocity, duration){
        //     sampler.triggerAttackRelease(note, duration, time, 1);
        //     // debugger;
        // });
        
        // Tone.Note.daveScore(indyFull, {
        //     "sampler" : "tk3"
        // });
        // Tone.Note.route("sampler", function(time, note, velocity, duration){
        //     sampler.triggerAttackRelease(note, duration, time, 1);
        //     // debugger;
        // });
        
        // Tone.Note.daveScore(indyFull, {
        //     "synth" : "tk4"
        // });
        // Tone.Note.route("synth", function(time, note, velocity, duration){
        //     synth.triggerAttackRelease(note, duration, time, 1);
        //     // debugger;
        // });

        Tone.Transport.setBpm(130);
        // Tone.Transport.setLoopEnd("1:0");
        // Tone.Transport.loop = true;

        // Tone.Transport.setTransportTime("4:0:0");
        var notes = [];
        var octave = 4;
        var recording = false;
        var down = {};
        
        var recordNotes = function(note, time, velocity){
            notes.push([time, note, velocity]);
            console.log(notes);
        };


        $(document).on('keydown', function(e){
            var note = getKey(e);

            if( e.which === 88 || e.which === 90 ){
                setOctave(e.which);
                down[e.which] = true;
            }

            if( note !== null ){
                if( down[note] === null || down[note] === undefined){
                    sampler.triggerAttack(note);
                    if (recording){
                        recordNotes(note, Tone.Transport.getTransportTime(), 1.00);
                    }
                    down[note] = true;
                }
            }
        });

        
        $(document).on('keyup', function(e){
            var note = getKey(e);

            if( e.which === 88 || e.which === 90 ){
                down[e.which] = null;
            }

            if( note !== null ){
                sampler.triggerRelease(note);
                if (recording){
                    recordNotes(note, Tone.Transport.getTransportTime(), 0.00);
                }
                down[note] = null;
            }
        });

        var getKey = function(event){
            switch (event.which){
                case 65 :
                    note = "C" + octave;
                    break;
                case 87 :
                    note = "Db" + octave;
                    break;
                case 83 :
                    note = "D" + octave;
                    break;
                case 69 :
                    note = "Eb" + octave;
                    break;
                case 68 :
                    note = "E" + octave;
                    break;
                case 70 :
                    note = "F" + octave;
                    break;
                case 84 :
                    note = "Gb" + octave;
                    break;
                case 71 :
                    note = "G" + octave;
                    break;
                case 89 :
                    note = "Ab" + octave;
                    break;
                case 72 :
                    note = "A" + octave;
                    break;
                case 85 :
                    note = "Bb" + octave;
                    break;
                case 74 :
                    note = "B" + octave;
                    break;
                case 75 :
                    note = "C" + (octave+1);
                    break;
                case 79 :
                    note = "Db" + (octave+1);
                    break;
                case 76 :
                    note = "D" + (octave+1);
                    break;
                case 80 :
                    note = "Eb" + (octave+1);
                    break;
                case 186 :
                    note = "E" + (octave+1);
                    break;
                case 222 :
                    note = "F" + (octave+1);
                    break;
                default:
                    note = null;
                    break;
            }

            return note;
        }

            
        var setOctave = function( key ){
            if( down[key] === null || down[key] === undefined){
                if( key === 90 ){
                    octave === 0 ? octave : octave--;
                }else if(key === 88 ){
                    octave >=7 ? octave: octave++;
                }
                $('#octave').html(octave);
            }
        };

        $('#keys').on('mousedown','button', function(){
            var note = $(this).attr("id");
            sampler.triggerAttack(note);
            if (recording){
                recordNotes(note, Tone.Transport.getTransportTime(), 1.00);
            }
        });

        $('#keys').on('mouseup','button', function(){
            var note = $(this).attr("id");
            sampler.triggerRelease(note);
            if (recording){
                recordNotes(note, Tone.Transport.getTransportTime(), 0.00);
            }
        })

        $('#rewind').on('click', function(){
            Tone.Transport.setTransportTime("0:0:0");
            $('#transportTime').text(Tone.Transport.getTransportTime());
        })


        $('#stop').on('click', function(){
            recording = false;
            $('#play').css("background-color", "white");
            $('#record').css({"background-color": "white", "color" : "red"});
            Tone.Transport.stop();
            Tone.Transport.clearIntervals();
        })

        $('#play').on('click', function(){
            $('#play').css("background-color", "green");
            Tone.Transport.start();
            Tone.Transport.setInterval(function(time){
                $('#transportTime').text(Tone.Transport.getTransportTime());
            }, "16n");

            Tone.Note.daveScore({
                "sampler" : notes
            });
            
            Tone.Note.route("sampler", function(time, note, velocity, duration){
                sampler.triggerAttackRelease(note, duration, time, 1);
            });
        })

        $('#record').on('click', function(){
            recording = true;
            $(this).css({"background-color": "red", "color" : "white"});
            Tone.Transport.setTransportTime("0:0:0");
            Tone.Transport.start();
            Tone.Transport.setInterval(function(time){
                $('#transportTime').text(Tone.Transport.getTransportTime());
            }, "16n");
        })



        //TURN ON TO HEAR MUSIC!!!!!
        // Tone.Transport.start();

    </script>

    
        <!-- build:js scripts/main.js -->

        <script src="scripts/main.js"></script>
        <!-- endbuild -->
</body>
</html>
